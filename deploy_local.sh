#!/bin/bash

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫—Ä–∏–ø—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ

# üìå –ü–∞–ø–∫–∞, –≥–¥–µ –±—É–¥–µ—Ç —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞—Ç—å—Å—è –ø—Ä–æ–µ–∫—Ç
DEPLOY_DIR="$HOME/vehiclepark_deploy_local"

echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –¥–µ–ø–ª–æ–π –≤ $DEPLOY_DIR"

# 1 –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
if [ -d "$DEPLOY_DIR" ]; then
    echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
    cd "$DEPLOY_DIR"
    docker-compose down || true  # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º, –Ω–æ –Ω–µ –≤—ã—Ö–æ–¥–∏–º –ø—Ä–∏ –æ—à–∏–±–∫–µ
else
    mkdir -p "$DEPLOY_DIR"
fi

# 2 –ö–æ–ø–∏—Ä—É–µ–º —Å–≤–µ–∂–∏–µ —Ñ–∞–π–ª—ã
echo "üìÇ –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞..."
rsync -av --exclude='.git' --exclude='node_modules' --exclude='target' . "$DEPLOY_DIR/"

# 3 –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É –∏ –∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã
cd "$DEPLOY_DIR"
echo "üê≥ –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
docker-compose up -d --build

# 4 –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
docker ps