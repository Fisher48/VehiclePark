name: üöÄ Local CI/CD Pipeline

on:
  workflow_dispatch:  # –ó–∞–ø—É—Å–∫ –≤—Ä—É—á–Ω—É—é
  push:
    branches:
      - test-deploy     # ‚Üê –ò—Å–ø–æ–ª—å–∑—É–π –ª—é–±—É—é —Ç–µ—Å—Ç–æ–≤—É—é –≤–µ—Ç–∫—É
      # - main (–º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üì• –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
        uses: actions/checkout@v4

      - name: üßæ –ü—Ä–æ–≤–µ—Ä–∫–∞ Docker –∏ Compose
        run: |
          docker -v
          docker compose version

      - name: üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
        run: |
          echo "POSTGRES_DB=test_db" >> $GITHUB_ENV
          echo "POSTGRES_USER=fisher48" >> $GITHUB_ENV
          echo "POSTGRES_PASSWORD=12345" >> $GITHUB_ENV

      - name: üì¶ –ë–∏–ª–¥–∏–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º docker-compose
        run: docker compose -f docker-compose.yaml up -d --build

      - name: ‚è± –û–∂–∏–¥–∞–µ–º –ø–æ–¥–Ω—è—Ç–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
        run: |
          echo "‚è≥ –ñ–¥—ë–º 30 —Å–µ–∫—É–Ω–¥..."
          sleep 30

      - name: üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —Å–µ—Ä–≤–∏—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, vehiclepark-core)
        run: curl --fail http://localhost:8888/actuator/health || (docker compose logs && exit 1)

      - name: üßº –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –æ—á–∏—Å—Ç–∫–∞
        if: always()
        run: |
          docker compose down
          docker system prune -f -a --volumes --force